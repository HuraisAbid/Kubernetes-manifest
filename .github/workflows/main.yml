name: CI/CD Pipeline

on:
  push:
    branches: [main]

env:
  FRONTEND_IMAGE: abidhurais/helm-manifest-frontend
  BACKEND_IMAGE: abidhurais/helm-manifest-backend
  NUMERIC_TAG: ${{ github.run_number }}

jobs:
# =====================================================
# 1. Detect Changes
# =====================================================
  detect-changes:
    runs-on: self-hosted
    outputs:
      frontend_changed: ${{ steps.detect.outputs.frontend }}
      backend_changed: ${{ steps.detect.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: detect
        run: |
          FRONTEND=false
          BACKEND=false

          git diff --name-only ${{ github.event.before }} ${{ github.sha }}

          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^frontend/'; then
            FRONTEND=true
          fi

          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^backend/'; then
            BACKEND=true
          fi

          echo "frontend=$FRONTEND" >> $GITHUB_OUTPUT
          echo "backend=$BACKEND" >> $GITHUB_OUTPUT

# =====================================================
# 2. Frontend Build
# =====================================================
  build-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend_changed == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Build & Push Frontend
        run: |
          echo "Building Frontend"
          docker build -t $FRONTEND_IMAGE:$NUMERIC_TAG frontend
          docker push $FRONTEND_IMAGE:$NUMERIC_TAG

# =====================================================
# 3. Backend Build
# =====================================================
  build-backend:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend_changed == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Build & Push Backend
        run: |
          echo "Building Backend"
          docker build -t $BACKEND_IMAGE:$NUMERIC_TAG backend
          docker push $BACKEND_IMAGE:$NUMERIC_TAG

# =====================================================
# 4. Deploy Frontend
# =====================================================
  deploy-frontend:
    needs: [detect-changes, build-frontend]
    if: needs.detect-changes.outputs.frontend_changed == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - run: |
          helm upgrade --install frontend helm/app \
            --namespace devops \
            --create-namespace \
            --set frontend.image=$FRONTEND_IMAGE \
            --set frontend.tag=$NUMERIC_TAG

# =====================================================
# 5. Deploy Backend
# =====================================================
  deploy-backend:
    needs: [detect-changes, build-backend]
    if: needs.detect-changes.outputs.backend_changed == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - run: |
          helm upgrade --install backend helm/app \
            --namespace devops \
            --create-namespace \
            --set backend.image=$BACKEND_IMAGE \
            --set backend.tag=$NUMERIC_TAG
